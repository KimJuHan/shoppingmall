<% include ../header.ejs %>
    


    <div class="panel panel-default">
        <div class="panel-heading">
            <%=product.product_name%>
        </div>
        <div class="panel-body">
            <div style="padding-bottom: 10px">
                작성일 : 
                    <% var date = new Date(product.createdAt); %>
                    <%=date.getFullYear()%> -
                    <%=date.getMonth()+1%> -
                    <%=date.getDate()%>
            </div>

            <% if(product.thumbnail){%>
            <p>
                <img src="/uploads/<%=product.thumbnail%>" style="max-width: 100%"/>
            </p>
            <% } %>

            <%-product.description%>

            <hr />
            
    <form action="" method="post" id="cartForm">
            <!--가격 -->
            <input type="hidden" name="price" value="<%=product.price%>">
            <!--갯수 -->
            <input type="hidden" name="number" value="1">
            <!--선택한 갯수 * 가격 = 구매가격 -->
            <input type="hidden" name="amount" value="<%=product.price%>">
        

            <div>
                <div class="printNum">갯수 : </div>
                <div class="CountBox">
                    <a href="#" type="minus">-</a>
                    <p id="amountHtml">1</p>
                    <a href="#" type="plus">+</a>
                </div>
                <div class="priceWrap">
                    금액 : <span id="priceHtml"><%=product.price%></span>
                </div>
                <div style="clear:both"></div>
            </div>
        </div>
    </div>

    <a href="/" class="btn btn-default">목록으로</a>
    <button class="btn btn-primary">장바구니 담기</button>

    </form>

<style>
.printNum { 
    float:left;
    margin-right: 10px; 
}
.CountBox { 
    width: 100px; 
    float:left; 
}
.CountBox a { 
    border : 1px solid #ddd; 
    display:block; 
    float:left; 
    padding: 4px 8px; 
    text-decoration: none;
}
.CountBox p { 
    border-top : 1px solid #ddd; 
    border-bottom : 1px solid #ddd; 
    display:block; 
    float:left; 
    padding: 4px 8px; 
}

.priceWrap { 
    float:right; 
    font-size: 20px;
}

.priceWrap span::after { 
    content : " 원";
}
</style>
<script>
    $(document).ready(function(){
        $('.CountBox a').click(function(event){
            event.preventDefault();

            var $total_num = $('input[name=number]').val();
            var $unit_price = $('input[name=price]').val();
            
            if($(this).attr('type') == 'minus'){
                $total_num -= (($total_num == 1)? 0 : 1)
            }else if($(this).attr('type') == 'plus'){
                $total_num ++
            }

            $('input[name=number]').val($total_num);
            $('input[name=amount]').val($total_num*$unit_price);
            $('#amountHtml').html($total_num);
            $('#priceHtml').html($total_num*$unit_price); 

        })

        $('#cartForm').submit(function(event){
            event.preventDefault();
            if(confirm('장바구니에 담겠습니까?')){
                //장바구니에 담길 ID,사진,이름,가격,갯수를 받는다
                var productId = <%=product.id%>;
                var thumbnail = "<%=product.thumbnail%>";
                var name = "<%=product.name%>";
                var price = "<%=product.price%>";
                var number = $('input[name=number]').val();

                var cartList = {};
                var totalAmount = 0;
                var now = new Date();
                var time = now.getTime();
                //한시간짜리 쿠키
                time += 3600*1000;
                now.setTime(time);

                cartList[productId] = {
                        name : name,
                        thumbnail : thumbnail,
                        number : number,
                        price : price
                        }; 
                
                $.ajax({
                    url: '/product/<%=product.id%>',
                    method: 'POST',
                    data: JSON.stringify(cartList),
                    dataType: 'json',
                    contentType: 'application/json',
                    success: function(data){
                        console.log("성공")
                    },
                    error: function(error){
                        console.log("에러")
                    }
                });
                
                //담긴 쿠키 없으면 ""인데, 이것도 split함수 먹히니까 노상관 
                //쿠키를 새로 갱신하는 방식이다. 기존의 쿠키를 새로운 변수에다가 넣어서 갱신하는 방식!
                (document.cookie).split(';').forEach(function(cookie){
                    // 구워진 쿠키 있는 경우
                    if(cookie !== undefined && cookie.indexOf('cartList') !== -1){
                        var originalCartList = decodeURIComponent(unescape(cookie));
                        while(originalCartList.charAt(0) == ' '){
                            originalCartList = originalCartList.substring(1);
                        }
                        var decodedOriginalCartList = JSON.parse(originalCartList.substring(9, originalCartList.length));
                        for( let key in decodedOriginalCartList ){
                            // 담았던 물건이랑 겹치는 경우
                            if(key == productId){
                                alert("이미 담으신 물건입니다. 지금 담으신 수량으로 대체합니다")
                            }else{
                                cartList[key] = decodedOriginalCartList[key];
                            }
                        }
                    }
                }); 
                
                // 쿠키에 domain 설정을 해주게 되면 IE에서는 동작하지 않는다. 
                document.cookie = "cartList" + "=" + escape(JSON.stringify(cartList)) + "; path=/; expires= false;"; 
                alert('장바구니에 담았습니다.');
            } 
        });
    });
</script>
<% include ../footer.ejs %>